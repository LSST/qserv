# -*- python -*-
Import('env')
Import('libProducts')
Import('defaultTgts')
Import('findLibs')
Import('cacheObjs')

import os
import itertools


programs = []
# extDeps
extDeps = "boost_regex boost_signals boost_thread boost_system mysqlclient_r protobuf log log4cxx pthread ssl crypto".split()

modDeps = 'global mysql sql util wbase wconfig wdb'.split() # deps on other modules
#modDeps = 'wbase wconfig wdb'.split() # deps on other modules
deps = itertools.chain(*map(lambda m: defaultTgts[m], modDeps))
pDeps = itertools.chain(*map(lambda m: libProducts[m], ["proto"]))
pDeps = cacheObjs(env, pDeps, ".o")
deps = map(lambda i:i, itertools.chain(deps, pDeps)) # un-chain
deps.sort(key=str)

# add a unit test which runs on every build
p = env.Program(['testQuerySql.cc'] + deps, LIBS=findLibs(extDeps))
programs.append(p)
utest = env.UnitTest(p)
env.Append(UNIT_TESTS=utest)

# Compile it but don't run on every build as it needs MySQL to run.
p = env.Program(['testQueryAction.cc'] + deps, LIBS=findLibs(extDeps))
programs.append(p)
#utest = env.UnitTest(p)
#env.Append(UNIT_TESTS=utest)

# add a unit test which runs on every build
p = env.Program(['testChunkResource.cc'] + deps, LIBS=findLibs(extDeps))
programs.append(p)
utest = env.UnitTest(p)
env.Append(UNIT_TESTS=utest)

Return('programs')
