# -*- python -*-
Import('env')
Import('libProducts')
Import('cacheObjs')
Import('findLibs')

import itertools
import os

programs = []

# deps on other modules
modDeps = [] 
deps = itertools.chain(*map(lambda m: libProducts[m], modDeps))
deps = cacheObjs(env, deps, ".o")
deps = map(lambda i:i, deps) # un-chain
myDeps = filter(lambda i: not os.path.basename(str(i)).startswith("test"),
                env.Glob("*.cc"))
extDeps = "boost_system crypto log log4cxx ssl ".split()

unitTests = ["testIterableFormatter.cc", "testMultiError.cc", "testCommon.cc"]

for test in unitTests:

    p = env.Program([test] + env.Object(myDeps) + deps, LIBS=findLibs(extDeps))
    programs.append(p)

    # add a unit test which runs on every build
    utest = env.UnitTest(p)
    env.Append(UNIT_TESTS=utest)

Return('programs')
